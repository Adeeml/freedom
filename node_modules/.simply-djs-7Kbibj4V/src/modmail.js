const Discord = require("discord.js");

/**
 * @param {Discord.Client} client
 * @param {Discord.Message} message
 * @param {import('../index').modmailOptions} options
 */

async function modmail(client, message, options = []) {
  let { MessageButton, MessageActionRow } = require("discord.js");
  try {
    if (options.credit === false) {
      foot = "Modmail";
    } else {
      foot = "©️ Simply Develop. npm i simply-djs";
    }

    if (message.channel.type === "DM") {
      if (!options.dmToggle || options.dmToggle === true) {
        let guildcol = [];

        if (options.blacklistUser) {
          for (let i = 0; i < options.blacklistUser.length; i++) {
            if (options.blacklistUser[i] === message.author.id)
              return message.reply(
                "You are blacklisted from creating mod-mails"
              );
          }
        }

        await client.guilds.cache.forEach(async (gu) => {
          let isit = await gu.members.fetch(message.author.id);
          if (isit) {
            if (isit.user.id === message.author.id) {
              let yikes = {
                label: gu.name,
                value: gu.id,
                description: "Guild you are in."
              };

              guildcol.push(yikes);
            }
          } else return;
        });
        const { MessageActionRow, MessageSelectMenu } = require("discord.js");
        let slct = new MessageSelectMenu()
          .setMaxValues(1)
          .setCustomId("guildselect")
          .setPlaceholder("What Guild ?")
          .addOptions([guildcol]);

        const row = new MessageActionRow().addComponents([slct]);

        let embed = new Discord.MessageEmbed()
          .setTitle("What Guild ?")
          .setDescription(
            `As this command is used in dms.. We dont know what guild you are trying to open the modmail. Please select the guild in the select menu`
          )
          .setFooter(foot)
          .setColor("#075FFF");

        message.channel
          .send({ embeds: [embed], components: [row] })
          .then(async (slct) => {
            let dmTr = slct.createMessageComponentCollector({
              type: "SELECT_MENU",
              time: 600000
            });

            dmTr.on("collect", async (menu) => {
              let val = menu.values[0];

              menu.deferUpdate();

              let mailname = `modmail_${message.author.id}`;

              if (options.blacklistGuild) {
                for (let i = 0; i < options.blacklistGuild.length; i++) {
                  if (options.blacklistGuild[i] === val)
           